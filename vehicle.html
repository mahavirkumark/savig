<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Data Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom primary color for consistency */
        .bg-primary-indigo { background-color: #4f46e5; }
        .text-primary-indigo { color: #4f46e5; }
        .border-primary-indigo { border-color: #4f46e5; }
        .hover\:bg-primary-indigo:hover { background-color: #4f46e5; }
        /* Custom styles for action buttons */
        .action-button {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: all 0.2s;
        }
    </style>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-primary-indigo">
                <i class="fas fa-car mr-2"></i> Vehicle Registry
            </h1>
            <div class="flex items-center space-x-4">
                <div class="flex flex-col text-right">
                    <span id="userName" class="font-semibold text-gray-700">Guest</span>
                    <span id="userEmail" class="text-sm text-gray-500">Not logged in</span>
                </div>
                <img id="userPhoto" src="https://via.placeholder.com/40" alt="User Photo" class="w-10 h-10 rounded-full border-2 border-primary-indigo">
                <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="auth-message" class="hidden text-center bg-white p-10 rounded-xl shadow-lg">
            <p class="text-2xl font-semibold text-gray-700 mb-4">You must be logged in to view this content.</p>
            <a href="index.html" class="inline-block bg-primary-indigo text-white px-6 py-2 rounded-lg hover:bg-indigo-600 transition duration-150">
                Go to Login Page
            </a>
        </div>

        <div id="main-content-area" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
            
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 id="form-title" class="text-xl font-bold mb-6 text-gray-800">Add New Vehicle üìù</h2>
                    
                    <form id="vehicleForm" class="space-y-4">
                        
                        <div>
                            <label for="ownerName" class="block text-sm font-medium text-gray-700">Owner Name <span class="text-red-500">*</span></label>
                            <input type="text" id="ownerName" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                        </div>
                        <div>
                            <label for="vehicleNo" class="block text-sm font-medium text-gray-700">Vehicle No. <span class="text-red-500">*</span></label>
                            <input type="text" id="vehicleNo" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border uppercase">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="vehicleType" class="block text-sm font-medium text-gray-700">Fuel/Vehicle Type</label>
                                <select id="vehicleType" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                                    <option value="">-- Select Type --</option>
                                    <option value="Petrol">Petrol</option>
                                    <option value="Electric">Electric</option>
                                    <option value="Diesel">Diesel</option>
                                    <option value="CNG">CNG/LPG</option>
                                    <option value="Hydrogen">Hydrogen</option>
                                </select>
                            </div>
                            <div>
                                <label for="pucDate" class="block text-sm font-medium text-gray-700">PUC Expiry Date</label>
                                <input type="date" id="pucDate" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                            </div>
                        </div>

                        <div>
                            <label for="companyName" class="block text-sm font-medium text-gray-700">Company Name</label>
                            <input type="text" id="companyName" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                        </div>
                        
                        <div>
                            <label for="modelName" class="block text-sm font-medium text-gray-700">Model Name</label>
                            <input type="text" id="modelName" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                        </div>

                        <div>
                            <label for="licenseNo" class="block text-sm font-medium text-gray-700">License/Registration No</label>
                            <input type="text" id="licenseNo" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                        </div>

                        <div>
                            <label for="chassisNo" class="block text-sm font-medium text-gray-700">Chassis No</label>
                            <input type="text" id="chassisNo" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                        </div>

                        <div>
                            <label for="engineNo" class="block text-sm font-medium text-gray-700">Engine No</label>
                            <input type="text" id="engineNo" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-indigo focus:border-primary-indigo p-2 border">
                        </div>

                        <div class="flex space-x-3 pt-2">
                            <button type="submit" id="submitButton" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-primary-indigo hover:bg-indigo-600 transition duration-150">
                                <i class="fas fa-plus mr-2"></i> Add Vehicle Data
                            </button>
                            <button type="button" onclick="resetForm()" id="cancelEditButton" class="hidden flex-shrink-0 py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>

                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="mb-6 bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4">
                    <i class="fas fa-search text-gray-400 text-lg"></i>
                    <input type="text" id="searchBar" onkeyup="filterVehicleData()" placeholder="Search by Owner Name or Vehicle No..." 
                           class="w-full p-2 border-b border-gray-300 focus:border-primary-indigo focus:ring-0 outline-none transition duration-150 text-gray-700">
                </div>
                
                <div id="vehicleDataList" class="space-y-4">
                    </div>
            </div>

        </div> </div> <script>
        // ** 1. YOUR FIREBASE CONFIGURATION **
        const firebaseConfig = {
            apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc",
            authDomain: "sk12-58e9e.firebaseapp.com",
            databaseURL: "https://sk12-58e9e-default-rtdb.firebaseio.com", 
            projectId: "sk12-58e9e",
            storageBucket: "sk12-58e9e.appspot.com",
            messagingSenderId: "470207874652",
            appId: "1:470207874652:web:67ba1cf3629b7e5b144899"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUserId = null;
        let vehiclesRef = null;
        let currentEditKey = null;
        let allVehiclesData = []; 

        // ** UI and Form Handling **
        window.resetForm = () => {
            currentEditKey = null;
            document.getElementById('vehicleForm').reset();
            document.getElementById('form-title').innerHTML = 'Add New Vehicle üìù';
            document.getElementById('submitButton').innerHTML = '<i class="fas fa-plus mr-2"></i> Add Vehicle Data';
            document.getElementById('submitButton').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            document.getElementById('submitButton').classList.add('bg-primary-indigo');
            document.getElementById('cancelEditButton').classList.add('hidden');
        };

        // ** Authentication **
        function updateUI(user) {
            const authMessage = document.getElementById('auth-message');
            const mainContent = document.getElementById('main-content-area');

            if (user) {
                currentUserId = user.uid;
                vehiclesRef = database.ref(`vehicles/${currentUserId}`);
                
                document.getElementById('userName').textContent = user.displayName || 'User Name';
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/40';
                
                authMessage.classList.add('hidden');
                mainContent.classList.remove('hidden');

                fetchVehicleData();

            } else {
                currentUserId = null;
                vehiclesRef = null;
                
                document.getElementById('userName').textContent = 'Guest';
                document.getElementById('userEmail').textContent = 'Not logged in';
                document.getElementById('userPhoto').src = 'https://via.placeholder.com/40';
                
                mainContent.classList.add('hidden');
                authMessage.classList.remove('hidden');
            }
            resetForm(); 
        }

        window.logout = () => {
            auth.signOut().then(() => {
                // REDIRECT TO index.html AFTER LOGOUT
                window.location.href = "index.html"; 
            }).catch((error) => {
                console.error("Logout error:", error);
                alert("An error occurred during logout. Please check the console.");
            });
        };

        auth.onAuthStateChanged(updateUI);

        // ** CRUD and Data Functions **
        
        const getValues = () => ({
            ownerName: document.getElementById('ownerName').value.trim(),
            vehicleNo: document.getElementById('vehicleNo').value.trim().toUpperCase(),
            vehicleType: document.getElementById('vehicleType').value.trim(),
            companyName: document.getElementById('companyName').value.trim(),
            modelName: document.getElementById('modelName').value.trim(),
            pucDate: document.getElementById('pucDate').value.trim(),
            licenseNo: document.getElementById('licenseNo').value.trim(),
            chassisNo: document.getElementById('chassisNo').value.trim(),
            engineNo: document.getElementById('engineNo').value.trim(),
            timestamp: Date.now()
        });

        document.getElementById('vehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!vehiclesRef) return;

            const data = getValues();
            
            if (currentEditKey) {
                vehiclesRef.child(currentEditKey).update(data)
                    .then(() => resetForm())
                    .catch(error => console.error("Update failed: ", error));
            } else {
                vehiclesRef.push(data)
                    .then(() => document.getElementById('vehicleForm').reset())
                    .catch(error => console.error("Save failed: ", error));
            }
        });

        // Helper to safely parse data for Edit/Share
        function getVehicleDataFromElement(key) {
            const data = allVehiclesData.find(v => v.key === key);
            return data;
        }

        window.editData = (key) => {
            const data = getVehicleDataFromElement(key);
            if (!data) return;

            currentEditKey = key;
            
            document.getElementById('ownerName').value = data.ownerName || '';
            document.getElementById('vehicleNo').value = data.vehicleNo || '';
            document.getElementById('vehicleType').value = data.vehicleType || '';
            document.getElementById('companyName').value = data.companyName || '';
            document.getElementById('modelName').value = data.modelName || '';
            document.getElementById('pucDate').value = data.pucDate || '';
            document.getElementById('licenseNo').value = data.licenseNo || '';
            document.getElementById('chassisNo').value = data.chassisNo || '';
            document.getElementById('engineNo').value = data.engineNo || '';
            
            document.getElementById('form-title').innerHTML = 'Edit Vehicle Data <i class="fas fa-edit text-yellow-500"></i>';
            document.getElementById('submitButton').innerHTML = '<i class="fas fa-save mr-2"></i> Update Vehicle Data';
            document.getElementById('submitButton').classList.remove('bg-primary-indigo');
            document.getElementById('submitButton').classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            document.getElementById('cancelEditButton').classList.remove('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.deleteData = (key, vehicleNo) => {
            if (!vehiclesRef) return;
            if (confirm(`Are you sure you want to delete the data for vehicle ${vehicleNo}?`)) {
                vehiclesRef.child(key).remove()
                    .catch(error => console.error("Delete failed: ", error));
            }
        };

        window.shareData = (key) => {
            const data = getVehicleDataFromElement(key);
            if (!data) return;

            // Generate the structured text content
            const getShareValue = (label, val) => (val && String(val).trim() !== '' ? `${label}: ${val}\n` : '');

            const shareText = 
                `--- Vehicle Info ---\n` +
                getShareValue('Owner Name', data.ownerName) +
                getShareValue('Vehicle No', data.vehicleNo) +
                getShareValue('Fuel Type', data.vehicleType) +
                getShareValue('Company', data.companyName) +
                getShareValue('Model', data.modelName) +
                getShareValue('PUC Date', data.pucDate) +
                getShareValue('License No', data.licenseNo) +
                getShareValue('Chassis No', data.chassisNo) +
                getShareValue('Engine No', data.engineNo);
                
            // Use Clipboard API for the most reliable "share" experience in a browser
            navigator.clipboard.writeText(shareText)
                .then(() => alert("Vehicle info copied to clipboard! You can now paste it into any chat or email."))
                .catch(err => {
                    console.error('Could not copy text: ', err);
                    alert("Failed to copy to clipboard. Please check console or try manually copying the text.");
                });
        };
        
        // ** Search Functionality **
        function filterVehicleData() {
            const searchBar = document.getElementById('searchBar');
            const filter = searchBar.value.toUpperCase();
            const filteredData = allVehiclesData.filter(vehicle => {
                const owner = vehicle.ownerName ? vehicle.ownerName.toUpperCase() : '';
                const vehicleNo = vehicle.vehicleNo ? vehicle.vehicleNo.toUpperCase() : '';
                return owner.includes(filter) || vehicleNo.includes(filter);
            });
            renderVehicleCards(filteredData);
        }
        window.filterVehicleData = filterVehicleData;

        // ** Rendering Function **
        function renderVehicleCards(vehicleList) {
            const vehicleDataList = document.getElementById('vehicleDataList');
            vehicleDataList.innerHTML = '';
            
            if (vehicleList.length === 0) {
                 vehicleDataList.innerHTML = `
                    <p class="text-gray-500 text-center p-8 bg-white rounded-xl shadow-lg">
                        <i class="fas fa-frown mr-2"></i> No matching vehicles found.
                    </p>
                `;
                return;
            }

            // Helper to conditionally display data
            const getDataRow = (label, value) => {
                if (!value || String(value).trim() === '') return '';
                // text-gray-900 ensures black font for details
                return `<p class="text-sm text-gray-900"><strong class="font-semibold">${label}:</strong> ${value}</p>`;
            };

            vehicleList.forEach(vehicle => {
                const card = document.createElement('div');
                card.className = "data-card bg-white p-5 rounded-xl shadow-lg border-l-4 border-primary-indigo hover:shadow-xl transition duration-300 transform";
                
                const fuelIcon = {
                    'Petrol': 'fa-gas-pump text-red-500',
                    'Electric': 'fa-bolt text-blue-500',
                    'CNG': 'fa-seedling text-green-500',
                    'Hydrogen': 'fa-flask text-sky-500',
                    'Diesel': 'fa-fire text-orange-500',
                    '': 'fa-question-circle text-gray-400'
                }[vehicle.vehicleType] || 'fa-question-circle text-gray-400';


                // Collect all optional fields (excluding Saved On)
                const optionalDetails = [
                    getDataRow('Fuel Type', vehicle.vehicleType),
                    getDataRow('Company Name', vehicle.companyName),
                    getDataRow('Model Name', vehicle.modelName),
                    getDataRow('PUC Date', vehicle.pucDate),
                    getDataRow('License No', vehicle.licenseNo),
                    getDataRow('Chassis No', vehicle.chassisNo),
                    getDataRow('Engine No', vehicle.engineNo)
                ].filter(Boolean).join('');


                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-grow">
                            <p class="text-max-xl font-bold text-gray-500"><strong class="font-semibold">Owner Name:</strong> ${vehicle.ownerName}</p>
                            <p class="text-lg font-extrabold text-gray-500 mb-2"><strong class="font-semibold">Vehicle No:</strong> ${vehicle.vehicleNo}</p>
                            
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-3 border-t pt-3">
                                ${optionalDetails}
                            </div>
                        </div>
                        
                        <div class="flex flex-col space-y-2 ml-4 flex-shrink-0 items-center">
                            <span class="text-2xl text-center mb-1"><i class="fas ${fuelIcon}"></i></span>
                            <div class="flex space-x-2">
                                <button onclick="editData('${vehicle.key}')" 
                                    class="action-button rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-500 hover:text-white" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="shareData('${vehicle.key}')" 
                                    class="action-button rounded-full bg-blue-100 text-blue-700 hover:bg-blue-500 hover:text-white" title="Share">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button onclick="deleteData('${vehicle.key}', '${vehicle.vehicleNo}')" 
                                    class="action-button rounded-full bg-red-100 text-red-700 hover:bg-red-500 hover:text-white" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                vehicleDataList.appendChild(card);
            });
        }


        // 8. Fetch Real-time Data
        function fetchVehicleData() {
            if (!vehiclesRef) return; 

            vehiclesRef.on('value', (snapshot) => {
                const data = snapshot.val();

                if (!data) {
                    allVehiclesData = [];
                    document.getElementById('vehicleDataList').innerHTML = `
                        <p class="text-gray-500 text-center p-8 bg-white rounded-xl shadow-lg">
                            <i class="fas fa-info-circle mr-2"></i> No vehicle data saved yet.
                        </p>
                    `;
                    return;
                }

                allVehiclesData = Object.keys(data).map(key => ({ key, ...data[key] }));
                allVehiclesData.sort((a, b) => b.timestamp - a.timestamp); 

                filterVehicleData(); 

            }, (error) => {
                console.error("Firebase read error: ", error);
                if (currentUserId) {
                     document.getElementById('vehicleDataList').innerHTML = `<p class="text-red-500 text-center p-8 bg-white rounded-xl shadow-lg">Error: Could not load data. Check console for details.</p>`;
                }
            });
        }
    </script>
</body>
</html>