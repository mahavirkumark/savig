
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery List - My Personal Website</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <style>
        /* Custom Tailwind Configuration */
        .primary-indigo { color: #4f46e5; }
        .text-primary-indigo { color: #4f46e5; }
        body { padding-top: 64px; }
        
        /* Ensure the main content containers fill the screen nicely */
        .list-container-order { order: 1; }
        .form-container-order { order: 0; }
        
        /* Desktop/Large Screen Order (Form on Left, Lists on Right) */
        @media (min-width: 1024px) { 
            body { padding-top: 80px; }
            .list-container-order { order: 1; }
            .form-container-order { order: 0; }
        }

        .btn-add { background-color: #1d4ed8; }
        .btn-add:hover { background-color: #1e40af; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50">

    <nav class="bg-white shadow-lg fixed w-full z-50 top-0">
        <div class="container mx-auto flex justify-between items-center p-4 md:px-8">
            <div class="flex items-center gap-2 text-xl font-bold text-gray-800">
                <i class="fas fa-user-circle" style="font-size: 28px; color: #4f46e5;"></i>
                <span style="font-size: 22px;">My Personal Website</span>
            </div>
            
            <div class="hidden md:flex space-x-6 font-medium">
                <a href="home.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-house"></i> Home</a>
                <a href="address.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-tasks"></i> Address</a>
                <a href="birthday.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-birthday-cake"></i> Birthday</a>
                <a href="password.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-key"></i> Passwords</a>
                <a href="income.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-wallet"></i> Income</a>
                <a href="links.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-link"></i> Links</a>
                <a href="calendar.html" class="flex items-center gap-2 transition duration-300 text-gray-600 hover:text-blue-500 hover:-translate-y-0.5" style="font-size: 18px;"><i class="fas fa-calendar-alt"></i> Calendar</a>
            </div>

            <div class="hidden lg:flex items-center gap-4"> 
                <div class="text-right">
                    <p id="userName" class="font-medium text-gray-900">Loading...</p>
                    <p id="userEmail" class="text-sm text-gray-500">Loading...</p>
                </div>
                <img id="userPhoto" src="https://via.placeholder.com/40" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #4f46e5;">
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition duration-300 text-sm">Logout</button>
            </div>
            
            <button id="menu-btn" class="md:hidden text-gray-700 text-2xl"><i class="fas fa-bars"></i></button>
        </div>

        <div id="mobileMenu" class="hidden md:hidden flex flex-col px-4 pb-4 space-y-2 text-sm text-gray-700 font-medium bg-gray-50">
            <a href="home.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-house"></i> Home</a>
            <a href="address.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-tasks"></i> Address</a>
            <a href="birthday.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-birthday-cake"></i> Birthday</a>
            <a href="password.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-key"></i> Passwords</a>
            <a href="income.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-wallet"></i> Income</a>
            <a href="links.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-link"></i> Links</a>
            <a href="calendar.html" class="flex items-center gap-2 p-2 rounded hover:bg-gray-200 hover:text-blue-500 transition duration-300"><i class="fas fa-calendar-alt"></i> Calendar</a>
            <div class="border-t border-gray-300 mt-2 pt-2">
                <p id="mobileUserName" class="font-medium text-gray-900">Loading...</p>
                <p id="mobileUserEmail" class="text-xs text-gray-500">Loading...</p>
                <button onclick="logout()" class="bg-red-500 text-white px-3 py-2 rounded-full hover:bg-red-600 mt-2 w-full">Logout</button>
            </div>
        </div>
    </nav>
    <main class="container mx-auto p-4 md:p-8 flex-grow">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-6 border-b-2 border-primary-indigo pb-2">
            <i class="fas fa-shopping-basket primary-indigo mr-2"></i> Real-time Grocery List
        </h1>
        
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="lg:w-1/3 bg-white p-6 rounded-xl shadow-lg h-fit border border-gray-200 form-container-order" id="addItemContainer">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                    <span>Add New Item</span>
                    <button id="toggleFormBtn" class="text-sm font-medium text-gray-500 hover:text-gray-800 transition">
                        <i class="fas fa-minus-circle mr-1" id="toggleIcon"></i> Collapse Form
                    </button>
                </h2>
                <form id="addItemForm" class="space-y-4">
                    
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name (e.g., Milk)</label>
                        <input type="text" id="item-name" required placeholder="Enter item name"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-indigo focus:border-primary-indigo">
                    </div>

                    <div>
                        <label for="item-quantity-value" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="number" id="item-quantity-value" min="0" step="any" placeholder="Value"
                                    class="block w-2/3 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-primary-indigo focus:border-primary-indigo">
                            <select id="item-quantity-unit"
                                    class="block w-1/3 py-2 px-3 border border-gray-300 bg-white rounded-r-md focus:outline-none focus:ring-primary-indigo focus:border-primary-indigo">
                                <option value="">Unit (Optional)</option>
                                <option value="pcs">Pcs (Pieces)</option>
                                <option value="g">g (Grams)</option>
                                <option value="kg">kg (Kilograms)</option>
                                <option value="ml">ml (Milliliters)</option>
                                <option value="L">L (Liters)</option>
                                <option value="box">Box</option>
                                <option value="can">Can</option>
                            </select>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Leave both fields empty for general details.</p>
                    </div>

                    <div>
                        <label for="item-date" class="block text-sm font-medium text-gray-700">Shopping Date</label>
                        <input type="date" id="item-date" required 
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-indigo focus:border-primary-indigo">
                    </div>
                    
                    <div>
                        <label for="item-photo" class="block text-sm font-medium text-gray-700">Item Photo (Optional)</label>
                        <input type="file" id="item-photo" accept="image/*"
                                class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-indigo/10 file:text-primary-indigo hover:file:bg-primary-indigo/20">
                    </div>

                    <button type="submit" id="submit-btn"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white btn-add hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 transition duration-150 ease-in-out">
                        <i class="fas fa-plus mr-2"></i> Add Item
                    </button>
                    <p id="upload-status" class="text-center text-sm text-green-600 hidden"></p>
                </form>
            </div>
            <div class="lg:w-2/3 space-y-8 list-container-order">
                
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200" id="todayListContainer">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center mb-2 sm:mb-0">
                            <i class="fas fa-calendar-check text-green-500 mr-2"></i> Today's Grocery List
                        </h2>
                        <div class="flex flex-wrap gap-2 sm:space-x-2"> 
                             <button onclick="shareList('today-list', 'Today_Grocery_List')" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full hover:bg-blue-600 transition duration-300">
                                 <i class="fas fa-share-alt mr-1"></i> Share
                            </button>
                             <button onclick="downloadPDF('today-list', 'Today_Grocery_List')" class="bg-red-500 text-white text-sm px-3 py-1 rounded-full hover:bg-red-600 transition duration-300">
                                 <i class="fas fa-file-pdf mr-1"></i> Download PDF
                            </button>
                        </div>
                    </div>
                    <p id="todayDateHeader" class="text-lg font-medium text-gray-600 mb-4 border-b pb-2"></p>
                    
                    <div id="today-list" class="space-y-4">
                        <p class="text-gray-500 italic text-center" id="today-list-empty">No items scheduled for today. Time to add some!</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200" id="upcomingListContainer">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center mb-2 sm:mb-0">
                            <i class="fas fa-calendar-alt text-yellow-500 mr-2"></i> Upcoming Grocery List (By Date)
                        </h2>
                        <div class="flex flex-wrap gap-2 sm:space-x-2">
                             <button onclick="shareList('upcoming-list', 'Upcoming_Grocery_List')" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full hover:bg-blue-600 transition duration-300">
                                 <i class="fas fa-share-alt mr-1"></i> Share
                            </button>
                             <button onclick="downloadPDF('upcoming-list', 'Upcoming_Grocery_List')" class="bg-red-500 text-white text-sm px-3 py-1 rounded-full hover:bg-red-600 transition duration-300">
                                 <i class="fas fa-file-pdf mr-1"></i> Download PDF
                            </button>
                        </div>
                    </div>
                    <div id="upcoming-list" class="space-y-4">
                        <p class="text-gray-500 italic text-center" id="upcoming-list-empty">No upcoming items scheduled.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center mb-2 sm:mb-0">
                            <i class="fas fa-history text-primary-indigo mr-2"></i> Past Completed Grocery List
                        </h2>
                        <div class="flex flex-wrap gap-2 sm:space-x-2">
                             <button onclick="shareList('completed-list', 'Completed_Grocery_List')" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full hover:bg-blue-600 transition duration-300">
                                 <i class="fas fa-share-alt mr-1"></i> Share
                            </button>
                            <button onclick="downloadPDF('completed-list', 'Completed_Grocery_List')" class="bg-red-500 text-white text-sm px-3 py-1 rounded-full hover:bg-red-600 transition duration-300">
                                <i class="fas fa-file-pdf mr-1"></i> Download PDF
                            </button>
                        </div>
                    </div>
                    <div id="completed-list" class="space-y-4">
                        <p class="text-gray-500 italic text-center" id="completed-list-empty">No items have been completed yet.</p>
                    </div>
                </div>

            </div>
            </div>
        <div class="mt-8 text-center">
             <button onclick="scrollToAddItem()" class="bg-primary-indigo text-white text-lg font-medium py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                 <i class="fas fa-plus-circle mr-2"></i> Quick Add Item
             </button>
        </div>

    </main>

    <footer class="mt-auto bg-white text-gray-600 text-center p-4 border-t text-sm fade-in border-t border-gray-200 mt-8">
        &copy; 2025 Personal Website | All rights reserved
    </footer>
    
    


<script>
Â  Â  Â  Â  // =========================================================
Â  Â  Â  Â  // ðŸ›‘ðŸ›‘ STEP 1: YOUR FIREBASE CONFIGURATION ðŸ›‘ðŸ›‘
Â  Â  Â  Â  // ðŸ”‘ IMPORTANT: Replace these values with your actual Firebase project configuration.
Â  Â  Â  Â  // =========================================================
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyB78RTVCg0cmSPp7A1RJyyAgBuCeolO0cc", // Placeholder
Â  Â  Â  Â  Â  Â  authDomain: "sk12-58e9e.firebaseapp.com", Â  Â  Â  Â // Placeholder
Â  Â  Â  Â  Â  Â  projectId: "sk12-58e9e", Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Placeholder
Â  Â  Â  Â  Â  Â  storageBucket: "sk12-58e9e.appspot.com", Â  Â  Â  Â  Â  // Placeholder
Â  Â  Â  Â  Â  Â  messagingSenderId: "470207874652", Â  Â  Â  Â  Â  Â  Â  Â  // Placeholder
Â  Â  Â  Â  Â  Â  appId: "1:470207874652:web:67ba1cf3629b7e5b144899" Â // Placeholder
Â  Â  Â  Â  };

Â  Â  Â  Â  // Initialize Firebase
Â  Â  Â  Â  const app = firebase.initializeApp(firebaseConfig);
Â  Â  Â  Â  const db = app.database();
Â  Â  Â  Â  const storage = app.storage();
Â  Â  Â  Â  const auth = app.auth(); 

Â  Â  Â  Â  let currentUserId = null; 
Â  Â  Â  Â  let userRef = null; 

Â  Â  Â  Â  // =========================================================
Â  Â  Â  Â  // --- HELPER FUNCTIONS ---
Â  Â  Â  Â  // =========================================================

Â  Â  Â  Â  const getTodayDateString = () => {
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const year = today.getFullYear();
Â  Â  Â  Â  Â  Â  const month = String(today.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  Â  Â  const day = String(today.getDate()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  return `${year}-${month}-${day}`;
Â  Â  Â  Â  };

Â  Â  Â  Â  const formatDate = (dateString) => {
Â  Â  Â  Â  Â  Â  if (!isNaN(dateString)) {
Â  Â  Â  Â  Â  Â  Â  Â  dateString = new Date(dateString).toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const date = new Date(dateString);
Â  Â  Â  Â  Â  Â  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  };

Â  Â  Â  Â  const formatQuantity = (item) => {
Â  Â  Â  Â  Â  Â  if (item.quantityValue && item.quantityUnit) {
Â  Â  Â  Â  Â  Â  Â  Â  return `${item.quantityValue} ${item.quantityUnit}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (item.quantityValue) return `${item.quantityValue}`;
Â  Â  Â  Â  Â  Â  if (item.quantityUnit) return `${item.quantityUnit}`;
Â  Â  Â  Â  Â  Â  return '1 Pcs'; 
Â  Â  Â  Â  };

Â  Â  Â  Â  // >>>>>>>>>>>>> MODIFIED FUNCTION STARTS HERE <<<<<<<<<<<<<
Â  Â  Â  Â  const formatItemText = (item) => {
Â  Â  Â  Â  Â  Â  const quantity = formatQuantity(item);
Â  Â  Â  Â  Â  Â  const name = item.name;
Â  Â  Â  Â  Â  Â  // CHANGE: Item Name first, then Quantity
Â  Â  Â  Â  Â  Â  return `${name} - ${quantity}`; 
Â  Â  Â  Â  }
Â  Â  Â  Â  // >>>>>>>>>>>>> MODIFIED FUNCTION ENDS HERE <<<<<<<<<<<<<

Â  Â  Â  Â  const checkAuth = () => {
Â  Â  Â  Â  Â  Â  if (!currentUserId || !userRef) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("User not authenticated. Please log in.");
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- GLOBAL LOGOUT FUNCTION ---
Â  Â  Â  Â  window.logout = () => {
Â  Â  Â  Â  Â  Â  auth.signOut().then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'index.html'; 
Â  Â  Â  Â  Â  Â  }).catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Logout Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("An error occurred during logout. Please try again.");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  // =========================================================
Â  Â  Â  Â  // --- DOM MANIPULATION AND EVENT LISTENERS ---
Â  Â  Â  Â  // =========================================================

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  const form = document.getElementById('addItemForm');
Â  Â  Â  Â  Â  Â  const menuBtn = document.getElementById('menu-btn');
Â  Â  Â  Â  Â  Â  const mobileMenu = document.getElementById('mobileMenu');
Â  Â  Â  Â  Â  Â  const toggleFormBtn = document.getElementById('toggleFormBtn');
Â  Â  Â  Â  Â  Â  const addItemContainer = document.getElementById('addItemContainer');
Â  Â  Â  Â  Â  Â  const itemDateInput = document.getElementById('item-date');
Â  Â  Â  Â  Â  Â  const todayDateHeader = document.getElementById('todayDateHeader');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const todayString = getTodayDateString();
Â  Â  Â  Â  Â  Â  itemDateInput.value = todayString;
Â  Â  Â  Â  Â  Â  todayDateHeader.textContent = `Date: ${formatDate(todayString)}`;

Â  Â  Â  Â  Â  Â  // --- Mobile Menu Toggle ---
Â  Â  Â  Â  Â  Â  menuBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  mobileMenu.classList.toggle('hidden');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- Form Toggle Functionality ---
Â  Â  Â  Â  Â  Â  toggleFormBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const formElements = form.querySelectorAll('div, button');
Â  Â  Â  Â  Â  Â  Â  Â  formElements.forEach(el => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check if the element is not the button itself or the form element
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (el.id !== 'toggleFormBtn' && el.id !== 'addItemForm' && !el.closest('h2')) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.classList.toggle('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Use a reliable way to check the state of the form (e.g., check the first input's parent div)
Â  Â  Â  Â  Â  Â  Â  Â  const firstInputDiv = form.querySelector('div');
Â  Â  Â  Â  Â  Â  Â  Â  const isHidden = firstInputDiv ? firstInputDiv.classList.contains('hidden') : false;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (isHidden) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleFormBtn.innerHTML = '<i class="fas fa-plus-circle mr-1"></i> Expand Form';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addItemContainer.classList.remove('p-6');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addItemContainer.classList.add('p-3');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleFormBtn.innerHTML = '<i class="fas fa-minus-circle mr-1"></i> Collapse Form';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addItemContainer.classList.remove('p-3');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addItemContainer.classList.add('p-6');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- Form Submission Handler ---
Â  Â  Â  Â  Â  Â  form.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!currentUserId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("User not authenticated. Cannot save item.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const itemName = document.getElementById('item-name').value;
Â  Â  Â  Â  Â  Â  Â  Â  const itemQuantityValue = document.getElementById('item-quantity-value').value;
Â  Â  Â  Â  Â  Â  Â  Â  const itemQuantityUnit = document.getElementById('item-quantity-unit').value;
Â  Â  Â  Â  Â  Â  Â  Â  const itemDate = document.getElementById('item-date').value; // YYYY-MM-DD format
Â  Â  Â  Â  Â  Â  Â  Â  const itemPhoto = document.getElementById('item-photo').files[0];
Â  Â  Â  Â  Â  Â  Â  Â  const uploadStatus = document.getElementById('upload-status');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-btn').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.textContent = 'Saving item...';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  let photoURL = null;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemPhoto) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.textContent = 'Uploading photo...';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const storageRef = storage.ref(`grocery_photos/${currentUserId}/${Date.now()}_${itemPhoto.name}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await storageRef.put(itemPhoto);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photoURL = await snapshot.ref.getDownloadURL();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newItem = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: itemName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantityValue: itemQuantityValue,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantityUnit: itemQuantityUnit,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photoURL: photoURL,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completed: false, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await userRef.child('groceryList').child(itemDate).push(newItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.textContent = 'Item saved successfully! âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDateInput.value = getTodayDateString(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.classList.remove('text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.classList.add('text-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => uploadStatus.classList.add('hidden'), 3000);

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving grocery item: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.textContent = 'Error saving item. Check console.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.classList.remove('text-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadStatus.classList.add('text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submit-btn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });


Â  Â  Â  Â  // --- Dynamic Item Element Creation ---
Â  Â  Â  Â  const createItemElement = (item, dateKey, isCompletedList = false) => {
Â  Â  Â  Â  Â  Â  const isCompleted = item.completed;
Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  const isToday = dateKey === getTodayDateString();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const baseClasses = 'flex items-center p-4 rounded-xl shadow-md transition duration-300';

Â  Â  Â  Â  Â  Â  if (isCompleted) {
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.className = `${baseClasses} bg-green-50 border-l-8 border-green-500 opacity-90`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.className = `${baseClasses} bg-white border-l-4 border-primary-indigo hover:shadow-lg hover:bg-gray-50`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Action Buttons Logic
Â  Â  Â  Â  Â  Â  const checkButton = isCompleted 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<button onclick="uncompleteItem('${dateKey}', '${item.id}')" class="text-green-600 hover:text-green-800 p-2 text-2xl rounded-full hover:bg-green-100 transition" title="Mark as Not Taken">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-undo"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>`
Â  Â  Â  Â  Â  Â  Â  Â  : `<button onclick="completeItem('${dateKey}', '${item.id}')" class="text-primary-indigo hover:text-indigo-700 p-2 text-2xl rounded-full hover:bg-indigo-100 transition" title="Mark as Taken">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-check-circle"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const editButton = isCompleted
Â  Â  Â  Â  Â  Â  Â  Â  ? '' 
Â  Â  Â  Â  Â  Â  Â  Â  : `<button onclick="editItem('${dateKey}', '${item.id}')" class="text-blue-500 hover:text-blue-700 p-2 text-2xl rounded-full hover:bg-blue-100 transition" title="Edit">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-pen"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>`;

Â  Â  Â  Â  Â  Â  const itemDetailsClass = isCompleted ? 'text-gray-600' : 'text-gray-900';
Â  Â  Â  Â  Â  Â  const itemDisplay = formatItemText(item);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const completedStatus = isCompleted ?
Â  Â  Â  Â  Â  Â  Â  Â  `<span class="text-sm font-medium text-green-700 ml-4 flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-award mr-1"></i> COMPLETED
Â  Â  Â  Â  Â  Â  Â  Â  </span>` : '';

Â  Â  Â  Â  Â  Â  // Footer for date (only shown in Upcoming list)
Â  Â  Â  Â  Â  Â  const dateFooter = (!isToday && !isCompleted && !isCompletedList) ? 
Â  Â  Â  Â  Â  Â  Â  Â  `<p class="text-xs text-red-500 font-medium mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-calendar-day mr-1"></i> Scheduled: ${formatDate(dateKey)}
Â  Â  Â  Â  Â  Â  Â  Â  </p>` : '';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Removed completed time display

Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  ${item.photoURL ? `<img src="${item.photoURL}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg mr-4 flex-shrink-0 cursor-pointer" onclick="window.open('${item.photoURL}')">` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow min-w-0 flex flex-col justify-center sm:flex-row sm:items-center sm:justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col min-w-0 sm:flex-row sm:items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-medium truncate ${itemDetailsClass}">${itemDisplay}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${completedStatus}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dateFooter}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-1 ml-4 flex-shrink-0 items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${checkButton} 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${editButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteItem('${dateKey}', '${item.id}', '${item.photoURL || ''}')" class="text-red-500 hover:text-red-700 p-2 text-2xl rounded-full hover:bg-red-100 transition" title="Delete">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-trash"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  return itemDiv;
Â  Â  Â  Â  };


Â  Â  Â  Â  // --- Function to set up the Realtime Database listener ---
Â  Â  Â  Â  const setupGroceryListListener = () => {
Â  Â  Â  Â  Â  Â  const todayList = document.getElementById('today-list');
Â  Â  Â  Â  Â  Â  const upcomingList = document.getElementById('upcoming-list');
Â  Â  Â  Â  Â  Â  const completedList = document.getElementById('completed-list');
Â  Â  Â  Â  Â  Â  const todayEmpty = document.getElementById('today-list-empty');
Â  Â  Â  Â  Â  Â  const upcomingEmpty = document.getElementById('upcoming-list-empty');
Â  Â  Â  Â  Â  Â  const completedEmpty = document.getElementById('completed-list-empty');
Â  Â  Â  Â  Â  Â  const todayDateString = getTodayDateString(); 
Â  Â  Â  Â  Â  Â  const groceryListRef = userRef.child('groceryList');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!userRef) return;

Â  Â  Â  Â  Â  Â  // 1. Listener for Today's List (Date-specific path)
Â  Â  Â  Â  Â  Â  groceryListRef.child(todayDateString).on('value', (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const items = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  todayList.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  todayEmpty.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  if (items) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const todayItems = Object.keys(items).map(key => ({ ...items[key], id: key }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todayItems.sort((a, b) => a.timestamp - b.timestamp);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (todayItems.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todayEmpty.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todayItems.forEach(item => todayList.appendChild(createItemElement(item, todayDateString)));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!todayEmpty.classList.contains('hidden')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todayList.appendChild(todayEmpty);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });


Â  Â  Â  Â  Â  Â  // 2. Listener for Upcoming & Past Completed (All dates)
Â  Â  Â  Â  Â  Â  groceryListRef.on('value', (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const allItemsByDate = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  upcomingList.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  completedList.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  upcomingEmpty.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  completedEmpty.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  let upcomingDays = [];
Â  Â  Â  Â  Â  Â  Â  Â  let completedItems = [];
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (allItemsByDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateKeys = Object.keys(allItemsByDate).sort();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateKeys.forEach(dateKey => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemsForDate = allItemsByDate[dateKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(itemsForDate).forEach(itemId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = { ...itemsForDate[itemId], id: itemId, dateKey: dateKey };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedItems.push(item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Filter for upcoming (dates after today) AND uncompleted
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dateKey > todayDateString && !item.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!upcomingDays.some(day => day.type === 'header' && day.date === dateKey)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upcomingDays.push({ type: 'header', date: dateKey });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upcomingDays.push({ type: 'item', ...item });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Populate Upcoming List
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (upcomingDays.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upcomingEmpty.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upcomingDays.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (a.date < b.date) return -1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (a.date > b.date) return 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return (a.timestamp || 0) - (b.timestamp || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentHeader = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upcomingDays.forEach(entry => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (entry.type === 'header' && entry.date !== currentHeader) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const headerDiv = document.createElement('h3');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headerDiv.className = 'text-xl font-medium text-yellow-600 mt-4 mb-2 pt-2 border-t border-dashed border-gray-300';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headerDiv.textContent = formatDate(entry.date);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â upcomingList.appendChild(headerDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentHeader = entry.date;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (entry.type === 'item') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â upcomingList.appendChild(createItemElement(entry, entry.dateKey));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â upcomingList.appendChild(upcomingEmpty);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Populate Completed List (Grouped by Scheduled Date)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedItems.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Primary sort: Scheduled date (dateKey) ascending
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (a.dateKey < b.dateKey) return -1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (a.dateKey > b.dateKey) return 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Secondary sort: completion time (completedAt) descending
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return b.completedAt - a.completedAt; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (completedItems.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedEmpty.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentDateHeader = null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Only add header if the scheduled date has changed
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.dateKey !== currentDateHeader) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const headerDiv = document.createElement('h3');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headerDiv.className = 'text-lg font-medium text-primary-indigo mt-4 mb-2 pt-2 border-t border-dashed border-gray-300';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headerDiv.textContent = `Scheduled Date: ${formatDate(item.dateKey)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â completedList.appendChild(headerDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentDateHeader = item.dateKey;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedList.appendChild(createItemElement(item, item.dateKey, true)); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedList.appendChild(completedEmpty);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upcomingList.appendChild(upcomingEmpty);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedList.appendChild(completedEmpty);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };


Â  Â  Â  Â  // =========================================================
Â  Â  Â  Â  // --- FIREBASE AUTH LISTENER AND INITIALIZATION (FIXED) ---
Â  Â  Â  Â  // =========================================================

Â  Â  Â  Â  auth.onAuthStateChanged((user) => {
Â  Â  Â  Â  Â  Â  const defaultPhoto = 'https://via.placeholder.com/40';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  userRef = db.ref('users/' + currentUserId);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const displayName = user.displayName || 'Guest User';
Â  Â  Â  Â  Â  Â  Â  Â  const email = user.email || 'No Email';
Â  Â  Â  Â  Â  Â  Â  Â  const photoURL = user.photoURL || defaultPhoto;

Â  Â  Â  Â  Â  Â  Â  Â  // Update navigation elements (Desktop and Mobile)
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userName').textContent = displayName;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userEmail').textContent = email;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userPhoto').src = photoURL;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mobileUserName').textContent = displayName;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mobileUserEmail').textContent = email;

Â  Â  Â  Â  Â  Â  Â  Â  setupGroceryListListener();

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Mock user for local testing if not using a real auth flow
Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = "user_123"; 
Â  Â  Â  Â  Â  Â  Â  Â  userRef = db.ref('users/' + currentUserId);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userName').textContent = 'Signed Out';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userEmail').textContent = 'Please log in';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userPhoto').src = defaultPhoto;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mobileUserName').textContent = 'Signed Out';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mobileUserEmail').textContent = 'Please log in';

Â  Â  Â  Â  Â  Â  Â  Â  setupGroceryListListener();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });


Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // --- GLOBAL WINDOW FUNCTIONS (CRUD & UTILITY) ---
Â  Â  Â  Â  // =========================================================================

Â  Â  Â  Â  window.completeItem = (dateKey, itemId) => {
Â  Â  Â  Â  Â  Â  if (!checkAuth()) return;
Â  Â  Â  Â  Â  Â  const itemRef = userRef.child('groceryList').child(dateKey).child(itemId);
Â  Â  Â  Â  Â  Â  itemRef.update({ completed: true, completedAt: Date.now() })
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log(`Item ${itemId} completed.`))
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.error("Error completing item:", error));
Â  Â  Â  Â  };

Â  Â  Â  Â  window.uncompleteItem = (dateKey, itemId) => {
Â  Â  Â  Â  Â  Â  if (!checkAuth()) return;
Â  Â  Â  Â  Â  Â  const itemRef = userRef.child('groceryList').child(dateKey).child(itemId);
Â  Â  Â  Â  Â  Â  itemRef.update({ completed: false, completedAt: null })
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log(`Item ${itemId} uncompleted.`))
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.error("Error uncompleting item:", error));
Â  Â  Â  Â  };

Â  Â  Â  Â  window.deleteItem = async (dateKey, itemId, photoURL) => {
Â  Â  Â  Â  Â  Â  if (!checkAuth() || !confirm("Are you sure you want to delete this grocery item?")) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const itemRef = userRef.child('groceryList').child(dateKey).child(itemId);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await itemRef.remove();
Â  Â  Â  Â  Â  Â  Â  Â  if (photoURL && !photoURL.includes('placeholder')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const storageRef = storage.refFromURL(photoURL);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await storageRef.delete().catch(e => { console.warn("Could not delete photo:", e); });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Item ${itemId} deleted successfully.`);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error deleting item:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Error deleting item. Check console.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.editItem = (dateKey, itemId) => {
Â  Â  Â  Â  Â  Â  if (!checkAuth()) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  userRef.child('groceryList').child(dateKey).child(itemId).once('value')
Â  Â  Â  Â  Â  Â  Â  Â  .then(snapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!item) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newName = prompt(`Edit item name (Date: ${formatDate(dateKey)}):`, item.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newName === null || newName.trim() === item.name) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newQtyVal = prompt(`Edit quantity value (currently: ${item.quantityValue || 'none'}):`, item.quantityValue || '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: newName.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantityValue: newQtyVal !== null ? newQtyVal.trim() : item.quantityValue,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userRef.child('groceryList').child(dateKey).child(itemId).update(updates)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log(`Item ${itemId} updated.`))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.error("Error updating item:", error));
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.error("Error fetching item for edit:", error));
Â  Â  Â  Â  };

Â  Â  Â  Â  window.scrollToAddItem = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('addItemContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
Â  Â  Â  Â  };


Â  Â  Â  Â  // 6. SHARE FUNCTION (Reduced font/text complexity for sharing)
Â  Â  Â  Â  window.shareList = (listId, filename) => {
Â  Â  Â  Â  Â  Â  if (!navigator.share) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Web Share API is not supported in your browser. Use the Download PDF option instead.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const listElement = document.getElementById(listId);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Collects items based on the data structure managed by Firebase for a cleaner list
Â  Â  Â  Â  Â  Â  const dateRef = listId === 'today-list' ? userRef.child('groceryList').child(getTodayDateString()) : userRef.child('groceryList');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  dateRef.once('value', (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const allItemsByDate = snapshot.val() || {};
Â  Â  Â  Â  Â  Â  Â  Â  let itemsToShare = [];

Â  Â  Â  Â  Â  Â  Â  Â  if (listId === 'today-list') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Process only today's items
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(allItemsByDate).forEach(itemId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = allItemsByDate[itemId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let text = formatItemText(item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.completed) text += ' (COMPLETED)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToShare.push(`- ${text}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Process Upcoming/Completed by iterating over all dates
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(allItemsByDate).sort().forEach(dateKey => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemsForDate = allItemsByDate[dateKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(itemsForDate).forEach(itemId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = itemsForDate[itemId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (listId === 'upcoming-list' && dateKey > getTodayDateString() && !item.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let text = formatItemText(item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += ` (Scheduled: ${formatDate(dateKey)})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToShare.push(`- ${text}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (listId === 'completed-list' && item.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let text = formatItemText(item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += ` (Scheduled: ${formatDate(dateKey)}, COMPLETED)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToShare.push(`- ${text}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (itemsToShare.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alert("The list is empty. Cannot share.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const title = filename.replace(/_/g, ' ') + (listId === 'today-list' ? ` (${formatDate(getTodayDateString())})` : '');
Â  Â  Â  Â  Â  Â  Â  Â  const shareText = `${title}:\n\n${itemsToShare.join('\n')}`;

Â  Â  Â  Â  Â  Â  Â  Â  navigator.share({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: title,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: shareText
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log('Successful share'))
Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => console.log('Error sharing', error));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };


Â  Â  Â  Â  // 7. PDF DOWNLOAD FUNCTION (Reduced max font size for items)
Â  Â  Â  Â  window.downloadPDF = async (listId, filename) => {
Â  Â  Â  Â  Â  Â  const listElement = document.getElementById(listId);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const listContainer = listElement.closest('div');
Â  Â  Â  Â  Â  Â  const listTitleElement = listContainer.querySelector('h2') || listContainer.querySelector('h1');
Â  Â  Â  Â  Â  Â  const listTitle = listTitleElement ? listTitleElement.textContent.trim() : filename.replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (listElement.children.length === 1 && listElement.children[0].id.endsWith('-empty')) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("The list is empty. Cannot generate PDF.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Temporary printable area to generate content as HTML/CSS
Â  Â  Â  Â  Â  Â  const printableArea = document.createElement('div');
Â  Â  Â  Â  Â  Â  printableArea.style.width = '700px'; 
Â  Â  Â  Â  Â  Â  printableArea.style.padding = '20px';
Â  Â  Â  Â  Â  Â  printableArea.style.backgroundColor = 'white';
Â  Â  Â  Â  Â  Â  printableArea.style.position = 'absolute';
Â  Â  Â  Â  Â  Â  printableArea.style.left = '-9999px'; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Header: Max font size 22px (20pt)
Â  Â  Â  Â  Â  Â  let headerHtml = `<h1 style="font-size: 18pt; font-weight: bold; margin-bottom: 5px; color: #1f2937;">${listTitle}</h1>`;
Â  Â  Â  Â  Â  Â  if (listId === 'today-list') {
Â  Â  Â  Â  Â  Â  Â  Â  headerHtml += `<p style="font-size: 10pt; margin-bottom: 20px; color: #4b5563;">Date: ${formatDate(getTodayDateString())}</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  printableArea.innerHTML = headerHtml;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Content Generation with reduced item font size (11pt)
Â  Â  Â  Â  Â  Â  const printContent = document.createElement('div');
Â  Â  Â  Â  Â  Â  printContent.style.fontFamily = 'Arial, sans-serif';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Array.from(listElement.children).forEach(child => {
Â  Â  Â  Â  Â  Â  Â  Â  if (child.tagName === 'H3') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Date Header for Completed/Upcoming
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const header = document.createElement('h4');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  header.textContent = child.textContent;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  header.style.fontSize = '10pt';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  header.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  header.style.marginTop = '15px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  header.style.marginBottom = '5px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  header.style.color = '#4f46e5';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  printContent.appendChild(header);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (child.classList.contains('flex')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Item Row
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemTextEl = child.querySelector('.text-lg');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const completedEl = child.querySelector('.text-sm.font-medium.text-green-700');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateEl = child.querySelector('.text-xs.text-red-500');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemTextEl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.text = itemTextEl.textContent.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.completed = completedEl ? completedEl.textContent.trim() : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.date = dateEl ? dateEl.textContent.trim().replace('Scheduled: ', '') : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.style.justifyContent = 'space-between';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.style.alignItems = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.style.borderBottom = '1px dashed #eee';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.style.padding = '5px 0';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Main Text (Reduced to 11pt)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mainText = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mainText.textContent = item.text;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mainText.style.fontSize = '11pt'; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mainText.style.color = item.completed ? '#4b5563' : '#1f2937'; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mainText.style.flexGrow = '1';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.appendChild(mainText);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Status/Date
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.fontSize = '9pt';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.style.textAlign = 'right';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML += `<span style="color: #047857; font-weight: bold;">${item.completed}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.date && listId !== 'completed-list') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusDiv.innerHTML += `<span style="color: #b91c1c; display: block;">(Scheduled: ${item.date})</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemDiv.appendChild(statusDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  printContent.appendChild(itemDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

            // Append the content to the printable area (not directly to document body)
            printableArea.appendChild(printContent);
            document.body.appendChild(printableArea);

            // Use html2canvas and jsPDF for PDF generation (assuming these libraries are included)
            const canvas = await html2canvas(printableArea, { scale: 2 });
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            
            // A4 size in points (595.28 x 841.89)
            const pdf = new jspdf.jsPDF('p', 'pt', 'a4'); 
            
            // Calculate dimensions
            const imgHeight = canvas.height * 595.28 / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            // Add the image (which contains all the formatted HTML content)
            pdf.addImage(imgData, 'JPEG', 0, position, 595.28, imgHeight);
            heightLeft -= 841.89; // Subtract one page height

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, 595.28, imgHeight);
                heightLeft -= 841.89;
            }

            // Save the PDF
            pdf.save(`${filename}_${getTodayDateString()}.pdf`);
            
            // Clean up the temporary element
            document.body.removeChild(printableArea);
Â  Â  Â  Â  };
</script>